<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Branch Video Player</title>

<style>
html,body{
  margin:0;
  background:#000;
  overflow:hidden;
}

#stage{
  position:fixed;
  inset:0;
}

/* ===== 動画 ===== */

video{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  opacity:0;
  transition:opacity 0.9s ease;
  pointer-events:none;   /* 動画はクリックを取らない */
  z-index:1;
}

video.active{ opacity:1; }

/* ===== 選択肢（中央） ===== */

#choices{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;

  gap:26px;
  width:100%;
  z-index:200;           /* 最前面 */

  opacity:0;
  transform:translateY(0px);
  transition:.5s ease;
}

#choices.show{
  opacity:1;
  transform:translateY(0);
}

.choiceBtn{
  width:min(460px,82vw);
  padding:20px 28px;
  font-size:clamp(18px,2.2vw,24px);
  color:white;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.35);
  background:linear-gradient(rgba(0,0,0,.55),rgba(0,0,0,.35));
  backdrop-filter: blur(12px);
  cursor:pointer;
  transition:.25s;
}

.choiceBtn:hover{
  background:rgba(255,255,255,.18);
  transform:scale(1.04);
}

/* ===== ローディング ===== */

#loading{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-size:22px;
  background:#000;
  z-index:500;
}

#fadeout{
  position:fixed;
  inset:0;
  background:#000;
  opacity:0;
  transition:opacity 1.5s;
  z-index:400;
  pointer-events:none;   /* 動画はクリックを取らない */
}
</style>
</head>

<body>

<div id="loading">Loading...</div>

<div id="stage">
  <video id="v1" muted playsinline preload="auto"></video>
  <video id="v2" muted playsinline preload="auto"></video>
  <div id="choices"></div>
</div>

<div id="fadeout"></div>

<script>
/* =========================
   設定
========================= */

const FLOWS = {
  A:{intro:"A1.mp4", loop:"A2.mp4"},
  B:{intro:"B1.mp4", loop:"B2.mp4"},
  C:{intro:"C1.mp4", loop:"C2.mp4"},
  D:{intro:"D1.mp4", loop:"D2.mp4"}
};

const ROUTE_CSV = `
A,B,Bルートへ
A,C,Cルートへ
B,C,Cルートへ
B,D,Dルートへ
C,D,Dルートへ
D,,
`;

const END_URL = "end.html";

/* ========================= */

function parseRouteCSV(text){
  const map={};
  text.trim().split("\n").forEach(line=>{
    const [from,to,label]=line.split(",").map(s=>s?.trim());
    if(!from) return;
    if(!map[from]) map[from]=[];
    if(to) map[from].push({to,label});
  });
  return map;
}

const ROUTE_TABLE = parseRouteCSV(ROUTE_CSV);

/* ===== 変数 ===== */

let v1=document.getElementById("v1");
let v2=document.getElementById("v2");
let current=v1;
let next=v2;
const choicesDiv=document.getElementById("choices");

/* ===== プリロード ===== */

function preloadAll(){
  const list=[];
  Object.values(FLOWS).forEach(f=>{
    list.push(f.intro,f.loop);
  });

  return Promise.all(list.map(src=>{
    return new Promise(res=>{
      const v=document.createElement("video");
      v.src=src;
      v.preload="auto";
      v.muted=true;
      v.playsInline=true;
      v.oncanplaythrough=res;
    });
  }));
}

/* ===== 動画 ===== */

function swap(){ [current,next]=[next,current]; }

function play(el,src,loop=false){
  el.src=src;
  el.loop=loop;
  el.load();
  el.play().catch(()=>{});
}

function fadeTo(src,loop=false,onEnd=null){
  play(next,src,loop);
  next.classList.add("active");
  current.classList.remove("active");
  next.onended=onEnd;
  swap();
}

/* ===== 選択肢 ===== */

function showChoices(route){
  choicesDiv.innerHTML="";

  (ROUTE_TABLE[route]||[]).forEach(row=>{
    const b=document.createElement("button");
    b.className="choiceBtn";
    b.textContent=row.label || row.to;
    b.addEventListener("click",()=>choose(row.to));
    choicesDiv.appendChild(b);
  });

  requestAnimationFrame(()=>choicesDiv.classList.add("show"));
}

function hideChoices(){
  choicesDiv.classList.remove("show");
  setTimeout(()=>choicesDiv.innerHTML="",400);
}

/* ===== フロー ===== */

function playFlow(route){
  hideChoices();
  const f=FLOWS[route];

  fadeTo(f.intro,false,()=>{
    if((ROUTE_TABLE[route]||[]).length===0){
      fadeTo(f.loop,false,()=>location.href=END_URL);
    }else{
      fadeTo(f.loop,true);
      showChoices(route);
    }
  });
}

function choose(route){
  if(!FLOWS[route]) return;
  playFlow(route);
}

/* ===== Safari解除 ===== */

function unlock(){ current.play().catch(()=>{}); }
document.addEventListener("touchstart",unlock,{once:true});
document.addEventListener("click",unlock,{once:true});

/* ===== 起動 ===== */

(async function(){
  await preloadAll();
  document.getElementById("loading").style.display="none";
  current.classList.add("active");
  playFlow("A");
})();
</script>

</body>
</html>
